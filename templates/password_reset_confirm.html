{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="csrf-token" content="{{ csrf_token }}" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="{% static 'assets/images/favicon.png' %}" type="image/x-icon">
    <title>Password Reset</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
      integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
</head>
<body>
    <div class="bg-cover bg-center min-h-screen flex items-center justify-center mb-20" style="background-image: url('{% static 'assets/images/reset.png' %}');">
        <div class="bg-white shadow-xl rounded-lg p-8 w-full max-w-md mx-4">
          <h2 class="text-2xl font-semibold text-gray-800 mb-2">Set a new password!</h2>
          <form method="post" novalidate>
            {% csrf_token %}

           <!-- New Password -->
            <div class="mb-6 relative">
                <label for="{{ form.new_password1.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                    {{ form.new_password1.label }}
                </label>
                <div class="relative flex items-center">
                    <input 
                        type="password"
                        name="{{ form.new_password1.name }}"
                        id="id_new_password1"
                        maxlength="74"
                        required
                        placeholder="New password"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 pr-10"
                    />
                    <i id="toggle-new-password1" class="fas fa-eye-slash absolute right-3 top-1/2 transform -translate-y-1/2 cursor-pointer text-gray-500"></i>
                </div>

                <!-- Tooltip -->
                <div id="password1-requirements" class="hidden absolute bottom-full mb-2 sm:left-full sm:ml-2 sm:top-0 sm:bottom-auto w-full sm:w-[300px] z-50 bg-gray-100 border border-gray-300 p-3 rounded-md shadow text-sm text-gray-700">
                    <p class="font-semibold mb-2">Password Requirements:</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li>Min. 8 characters</li>
                        <li>Include 1 uppercase, 1 lowercase, 1 number, 1 special character</li>
                        <li>No spaces or these: ? &lt; &gt; ( ) ' " / \ &amp;</li>
                        <li>Must not contain your name or email</li>
                    </ul>
                </div>

                <span id="new-password-error" class="text-red-500 text-sm mt-1 block"></span>
            </div>

            <!-- Confirm Password -->
            <div class="mb-6 relative">
                <label for="{{ form.new_password2.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                    {{ form.new_password2.label }}
                </label>
                <div class="relative flex items-center">
                    <input 
                        type="password"
                        name="{{ form.new_password2.name }}"
                        id="id_new_password2"
                        required
                        placeholder="Confirm password"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 pr-10"
                    />
                    <i id="toggle-new-password2" class="fas fa-eye-slash absolute right-3 top-1/2 transform -translate-y-1/2 cursor-pointer text-gray-500"></i>
                </div>

                <span id="confirm-password-error" class="text-red-500 text-sm mt-1 block"></span>
            </div>



            <!-- Submit button -->
            <button type="submit" class="w-full bg-[#F79533] hover:bg-[#E0852E] text-white font-medium py-2 rounded-md transition duration-200">
                Reset Password
            </button>
        </form>


            <p class="text-sm text-gray-700 mt-6 text-center">
            Want to go back Home? <a href="{% url 'accounts:home' %}" class="text-[#F79533] hover:underline">Click to Home</a>
            </p>
        </div>
    </div>
    
    {% include "layout/partials/footer.html" %}



<script>
document.addEventListener("DOMContentLoaded", function () {
    // Toggle eye icon logic
    function setupPasswordToggle(inputId, iconId) {
        const input = document.getElementById(inputId);
        const icon = document.getElementById(iconId);

        icon.addEventListener('click', function () {
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            }
        });
    }

    setupPasswordToggle('id_new_password1', 'toggle-new-password1');
    setupPasswordToggle('id_new_password2', 'toggle-new-password2');

    // Tooltip visibility
    const newPasswordInput = document.getElementById('id_new_password1');
    const tooltip = document.getElementById('password1-requirements');

    newPasswordInput.addEventListener('focus', () => tooltip.style.display = 'block');
    newPasswordInput.addEventListener('blur', () => {
        tooltip.style.display = 'none';
        validatePassword(newPasswordInput, 'new-password-error');
    });

    // Confirm password validation
    const confirmPasswordInput = document.getElementById('id_new_password2');
    confirmPasswordInput.addEventListener('blur', () => {
        validateConfirmPassword();
    });

    function validatePassword(field, errorId) {
        const password = field.value.trim();
        const error = document.getElementById(errorId);

        const validPattern = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@‚Äê,._%*:;=^!#$+\[\]`{}|~]).{8,74}$/;
        const disallowedPattern = /['"()<>\/\\&?\s]/;

        if (!password) {
            error.textContent = "Password is required.";
            field.style.border = "2px solid red";
        } else if (password.length < 8 || password.length > 74) {
            error.textContent = "Password must be between 8 and 74 characters.";
            field.style.border = "2px solid red";
        } else if (!validPattern.test(password)) {
            error.textContent = "Must include uppercase, lowercase, number, and special character.";
            field.style.border = "2px solid red";
        } else if (disallowedPattern.test(password)) {
            error.textContent = "Password contains invalid characters.";
            field.style.border = "2px solid red";
        } else {
            error.textContent = "";
            field.style.border = "";
        }

        validateConfirmPassword(); // Recheck confirm password match if user edits new password
    }

    function validateConfirmPassword() {
        const newPassword = newPasswordInput.value.trim();
        const confirmPassword = confirmPasswordInput.value.trim();
        const error = document.getElementById('confirm-password-error');

        if (!confirmPassword) {
            error.textContent = "Please confirm your password.";
            confirmPasswordInput.style.border = "2px solid red";
        } else if (newPassword !== confirmPassword) {
            error.textContent = "Passwords do not match.";
            confirmPasswordInput.style.border = "2px solid red";
        } else {
            error.textContent = "";
            confirmPasswordInput.style.border = "";
        }
    }
});

</script>

</body>
</html>